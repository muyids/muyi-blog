#### 背景

为了在一个平台上统一管理各个应用下的角色和权限，同时避免在不同业务系统中的重复代码逻辑

#### **业务权限**

**区分为功能权限+数据权限**

举一个场景：

场景 1：获取一个用户的所有文档列表信息

进行权限拆分

- 功能权限: 获取文档列表

- 数据权限：和此用户关联的文档列表

基于此，**权限系统只对功能权限做统一的管理**，不同数据权限场景较为复杂，和业务本身的绑定程度非常高！并不是一个通用程度很高的模块，应由业务系统本身实现；下图应该为一次完整的权限验证过程：

![2021-09-03 pm1.56.24](https://muyids.oss-cn-beijing.aliyuncs.com/2021-09-03%20pm1.56.24.png)

#### RBAC 模型

RBAC 是 Role-BasedAccess Control 的英文缩写，意思是基于角色的访问控制

#### RBAC0

RBAC0 定义了能构成 RBAC 控制系统的最小的元素集合，由四部分构成：

- 用户（User）
- 角色（Role）
- 会话（Session）
- 许可（Pemission）

#### 设计原则

本系统基于 RBAC0 的模型实现了基本的权限控制，并增加了应用的概念；

**应用**

目前互联网的系统往往是有多个服务构成，权限的设计也应考虑满足多个应用共同使用的情况；增加应用的概念有下面两点好处：

- 约束权限的作用范围
- 以应用为单位进行角色、权限管理，方便操作
  创建应用：

应用的创建者将会成为此应用的管理者，拥有此应用下的所有操作权限；

应用 appKey，appSecret 是请求权限系统各个接口的重要鉴权信息

**角色**

**一个用户可以拥有多个角色，角色间的权限是互不关联的，不存在父子或者继承关系**

当前权限系统没有引入**组**的概念，也就是角色之前没有上下级关系，如果对于需要有角色的上下级关系的场景，我们应如何实现呢？

比如：角色 1：普通用户，角色 2：管理员，角色 3：超级管理员；权限上 超级管理员 > 管理员 > 普通用户，前者都应该拥有后者的所有权限，该怎么做？

在当前系统中的实现应该是

用户 1 = 角色 1 = 普通用户所有权限

用户 2 = 角色 2 = 管理员所有权限+普通用户所有权限

用户 3 = 角色 3 = 超级管理员所有权限+管理员所有权限+普通用户所有权限

角色间只需要维护自身特有的权限即可，如果有权限交集，自然也没关系

**权限**

**命名规则：**

**后端接口权限：**

强烈建议，后端接口权限使用**api 方法名+api 请求 path**的方式

如：get:/api/user/getAllList

为什么如此建议？

> **因为权限系统本身的设计就是基于 api 接口，如果使用其他方式的命名，在业务系统中必须要存储权限名称到 api 接口的映射关系（权限系统后续可能引入权限组的概念）**

**前端页面权限：**

强烈建议，前后端明确的区分接口和页面地址，比如后端的接口都统一/api 前缀，

如此一来，如添加前端页面权限：/user/getInfo

**前端可以自行在页面初始化时，加载一个用户的所有权限列表**

**在请求接口前，前端路由跳转前判断是否拥有接口和页面的权限，然后做自定义处理**

**权限树**

实际业务场景中会有一级菜单，二级菜单，三级菜单。。。如果我们只配置叶子菜单权限，可想而知权限的管理维护会变成一件繁重的工作。如何让操作变得简单，更易于被操作人员所接受呢？这里我们引入权限树的概念，假设根节点为虚拟节点-1，一级菜单即为树的第一层节点，二级菜单为树的第二层节点。。。

后端接口也可以类比前端菜单页面对接口权限进行分组，并按上下级关系，抽象为树结构。

我们规定权限树的非叶子节点只负责管理权限分组，不指定具体的资源，叶子节点表示具体的资源权限

**交互和存储数据结构设计**

后端存储：采用关系型数据库，在权限节点记录中增加父节点的关联支持；

前端展示：权限树使用树结构呈现

**角色权限树的维护**

角色权限树只有该应用的管理员可以维护；管理员登录后台角色的权限管理页面时，可以获取到包括所有权限的整棵权限树，结构如下图所示：

![2021-09-10 am10.29.17](https://muyids.oss-cn-beijing.aliyuncs.com/2021-09-10 am10.29.17.png)

权限树的呈现已经确定，接下来，权限管理该如何操作呢？

**1.返回权限树：**

返回给前端权限树为整个 json 嵌套结构，后期随着权限数据量增长，可以根据层级返回以优化性能；

**2.新增权限：**

只能进行新增下级权限操作，选中父节点，点击增加，创建子权限

**3.删除权限**

叶子和非叶子节点都支持删除操作；删除非叶子节点，同步删除该节点下的所有级联子节点；删除叶子节点，只删除当前节点

**4.授权或取消授权**

授权要进行两步操作：1.对下级的所有节点授权；2.对上级节点授权，目的是返回权限树时可以索引到授权的下级节点；

取消授权同样也需要进行两步操作：1.对下级的所有节点取消授权；2.上级节点的操作：判断上级节点是否还拥有任何下级节点的权限，如果有，维持现状保留上级权限，如果没有，则删除上级节点权限；

**注意：**上下级节点的操作都应该是递归的，直到到达叶子节点或根节点，递归结束。

**用户的角色**

参考上述有关**角色**的描述，尤其是上下级关系的场景实现

**用户的权限**

一个用户具有不同角色，每个角色都有对应的角色树，那么用户的权限应如何定义呢？

我们定义用户的权限为其所属的所有角色的并集。

**后端接口权限自动配置**

后端 web 接口使用 springboot 技术栈开发，接口文档由 swagger-ui 提供，后续开发注解方式自动将后端接口权限入库（TODO）

#### 表结构设计

**通用数据表字段**

| 字段        | 类型        | 说明                                                                  |
| :---------- | :---------- | :-------------------------------------------------------------------- |
| id          | int         | mysql 自增主键 id                                                     |
| deleted_at  | bigint(16)  | 用于记录逻辑删除，为 0 时表示未删除，当时其他 13 位时间戳，表示已删除 |
| create_time | datetime(3) | 创建时间                                                              |
| update_time | datetime(3) | 修改时间                                                              |

关于`actived`字段

目前第一版暂不支持，只支持删除功能

**application**

简介：应用表，存储应用的基本信息

| 字段       | 类型         | 说明                           |
| :--------- | :----------- | :----------------------------- |
| app_key    | varchar(64)  | 应用的唯一 key，生成规则：UUID |
| app_secret | varchar(64)  | 应用秘钥                       |
| app_name   | varchar(64)  | 应用名称                       |
| url        | varchar(256) | 应用项目地址                   |
| desc       | varchar(256) | 应用描述信息                   |

**user_application**

简介：用户管理应用表，存储应用和用户的关联

| 字段    | 类型        | 说明    |
| :------ | :---------- | :------ |
| app_id  | bigint(16)  | 应用 id |
| user_id | varchar(64) | 用户 id |

**user**

简介：用户信息表

| 字段     | 类型         | 说明                          |
| :------- | :----------- | :---------------------------- |
| id       | bigint(16)   | 用户 id，生成规则基于 id-only |
| username | varchar(32)  | 用户名称                      |
| male     | tinyint(1)   | 性别                          |
| mobile   | bigint(16)   | 手机号                        |
| email    | varchar(64)  | 邮箱                          |
| Address  | varchar(256) | 地址                          |

**user_account**

简介：用户登录信息表

| 字段       | 类型        | 说明                          |
| :--------- | :---------- | :---------------------------- |
| user_id    | bigint(16)  | 用户 id，生成规则基于 id-only |
| type       | tinyint(1)  | 1:用户名;2:手机号;3:邮箱      |
| login_name | varchar(64) | 登录名                        |
| salt       | varchar(20) | 盐                            |
| password   | varchar(64) | 密码                          |

**user_session**

简介：用户会话信息表

| 字段            | 类型         | 说明                          |
| :-------------- | :----------- | :---------------------------- |
| user_id         | bigint(16)   | 用户 id，生成规则基于 id-only |
| type            | tinyint(1)   | 1:用户名;2:手机号;3:邮箱      |
| rtk             | varchar(128) | refresh token                 |
| parent_rtk      | varchar(128) | 父 refresh-token              |
| rtk_expire_time | datetime     | refresh token 过期时间        |
| **索引**        | **字段**     | **说明**                      |
| unique_rtk      | rtk          | rtk 唯一索引，BTREE           |

**user_role**

简介：用户角色关联表，存储用户拥有的角色

| 字段    | 类型       | 说明    |
| :------ | :--------- | :------ |
| user_id | bigint(16) | 用户 id |
| role_id | bigint(16) | 角色 id |

**role**

简介：角色表，存储角色和应用的关联

| 字段   | 类型         | 说明              |
| :----- | :----------- | :---------------- |
| name   | varchar(64)  | 角色名称          |
| app_id | varchar(64)  | 所属应用的唯一 id |
| desc   | varchar(256) | 角色描述信息      |

**permission**

简介：权限表，存储应用对应的各种权限

| 字段      | 类型         | 说明                            |
| :-------- | :----------- | :------------------------------ |
| name      | varchar(64)  | 权限名称                        |
| resource  | varchar(256) | 权限资源                        |
| app_id    | varchar(64)  | 所属应用的唯一 id               |
| parent_id | bigint(16)   | 父节点权限 id（没有父节点为-1） |

**role_permission**

| 字段          | 类型       | 说明              |
| :------------ | :--------- | :---------------- |
| role_id       | bigint(16) | 所属应用的唯一 id |
| permission_id | bigint(16) | 权限 id           |

#### 接口设计

**应用**

- 创建应用

- 应用列表
- 删除应用
- 停用应用 - 暂不提供
- 启用应用 - 暂不提供
  **角色**

- 创建角色
- 角色列表
- 删除角色
- 停用角色 - 暂不提供
- 启用角色 - 暂不提供

**权限**

- 创建权限
- 应用权限列表
- 角色权限列表
- 删除权限
- 停用权限 - 暂不提供
- 启用权限 - 暂不提供
- 角色增加权限
- 角色删除权限
