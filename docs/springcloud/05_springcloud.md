图灵-诸葛

阿里微服务架构 Spring Cloud Alibaba 深度源码

1、Nacos 服务注册与发现源码深度剖析
2、Nacos 心跳机制与服务健康检查源码剖析
3、Nacos 注册表如何防止多节点读写并发冲突
4、Nacos 高并发支撑异步任务与内存队列剖析
5、Nacos 集群 CP 架构底层 Raft 协议实现源码剖析
6、从脑裂问题剖析 Nacos&Eureka&Zookeeper 架构异同
7、阿里云超大规模注册中心 SaaS 架构剖析
8、Sentinel 底层滑动时间窗限流算法深度剖析
9、利用 Sentinel 的 Metric 机制计算线上系统实时 QPS

## 10、Seata 分布式事务回滚机制剖析

# Spring Cloud

## 介绍

### Spring Cloud 是什么

- SpringCloud 为开发者提供了一套快速开发分布式系统的组件
- SpringCloud 并不推荐重复造轮子
- 主张利用 SpringBoot 将其他公司较成熟的组件进行封装

### 核心概念

配置中心、注册中心、服务网关、负载均衡、RPC 调用、服务熔断、服务降级、服务限流、全局锁、控制总线、分布式事务、服务安全、链路追踪、集群管理、事件驱动、任务调度、云连接器、函数计算

## 分布式配置中心

### 分布式配置中心的由来

微服务系统中，存在很多功能开关和各种参数的配置项，传统的配置文件、数据库等方式无法满足开发人员对配置管理的需求。
所以，分布式配置中心应运而生

### 分布式配置中心的特点

- 统一管理

  配置中心服务端负责配置的管理（增、删、改、发布），集成了配置中心客户端的微服务程序可以统一从配置中心服务端拉取配置，从而实现整个微服务系统的统一配置管理

- 区分环境

  在不同环境（开发、测试、生产）中配置项通常是不同的
  分布式配置中心需要具有隔离不同环境的功能

- 实时刷新

  当配置中心服务端中的配置发生修改时，配置中心客户端能实时监听到配置的改变，使得微服务应用程序可以实时获取最新配置，并且不需要重新部署应用程序

- 权限控制

  在配置中心，可以针对不同的角色或用户设置对应的权限

- 版本控制

  使用配置中心过程中，出现误操作，可以进行版本回退

- 灰度发布

  如果需要发布到多个实例，可以只发布到部分实例，待测试通过后，再发布到全部实例，这就是配置的灰度发布

## 分布式注册中心

### 什么是注册中心

注册中心相当于微服务架构中的地址通讯录
每个微服务会将服务及其地址注册到注册中心
服务消费者在调用某个微服务前会先从注册中心查找服务地址，然后进行调用

### 注册中心的特点

- 服务的自动注册

  微服务应用在启动时，通过注册中心客户端组件，将服务相关信息自动注册给注册中心服务端

- 服务的健康检查

  当已经注册到注册中心的微服务实例宕机后，注册中心服务端能发现实例宕机，并把相关信息从注册中心删除掉

- 服务的自动发现

  服务消费者需要能实时监听到注册中心中服务信息的变更，以能在真正调用服务时不会出现错误

### 常见注册中心组件

- Zookeeper
- Eureka
- Nacos
- Consul

## 服务网关

### 什么是服务网关

服务网关是整个微服务架构中对外的统一入口
所有客户端都通过统一的网关使用微服务
微服务网关起到了隔离外部访问和内部系统的作用
服务网关是微服务架构中的一个标配组件

### 服务网关的特点

- 高并发

  作为微服务架构中的对外入口，必须能支持高并发，能承担更高的并发量，并保证高性能

- 安全

  服务网关通常具有权限认证、黑名单、白名单等保证网关安全的功能

- 路由转发

  服务网关接收到外部请求后，要求服务网关能根据请求和配置将请求转发到对应的后端微服务上去

- 监控与限流

  作为整个系统的流量入口，服务网关要能监控流量情况，遇到突发情况能及时限流，保证整个系统的稳定

- 灰度发布

  当某个微服务有新版本上线时，可以利用服务网关进行流量的切换，实现该微服务的灰度发布

- 服务重试

  当服务网关调用某个微服务失败后，可以通过服务网关设置重试策略来重新尝试调用该服务

- 服务别名

  可以在服务网关中给某个或某些微服务设置别名，从而对外屏蔽内部微服务相关信息

### 常见服务网关组件

- Kong
- Zuul
- Spring Cloud Gateway

### Spring Cloud Gateway

- 可以很方便的和 Spring Cloud 生态中的其他组件进行集成（比如断路器和服务发现）
- 提供了一套简单易写的 **断言**（**Predicates**，有的地方也翻译成 **谓词**）和 **过滤器**（**Filters**）机制，可以对每个 **路由**（**Routes**）进行特殊请求处理。
  https://cloud.spring.io/spring-cloud-gateway/reference/html/

术语

- Route: 路由；网关基本组成单位；通过一个 id，一个目的 uri，一组断言的集合和一组过滤器的集合组成；当聚合断言为 true 时，表示路由被匹配上了。
- Predicate：断言； [Java 8 Function Predicate](https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html)；输入类型是 [Spring Framework `ServerWebExchange`](https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/ServerWebExchange.html)；用于匹配 http 请求，比如通过请求头或者参数
- Filter: 过滤器；特殊工厂构建的 Spring Framework GatewayFilter 的实例；能够在发送给下游请求前后修改请求和响应

```yml
spring:
  cloud:
    gateway:
      routes: # routes的配置
        - id: dera-log
          uri: lb://dera-log
          predicates:
            - Between=2017-01-20T17:42:47.789-07:00[America/Denver], 2017-01-21T17:42:47.789-07:00[America/Denver]
          	- Cookie=chocolate, ch.p
          	- Header=X-Request-Id, \d+
            - Path=/log/**
            - Host=**.somehost.org,**.anotherhost.org
            - Method=GET,POST
            - Query=green
            - RemoteAddr=192.168.1.1/24
          filters:
           	- AddRequestHeader=X-Request-red, blue
           	- AddRequestHeader=X-Request-Red, Blue-{segment}
            - name: SignCheck
```

### 网关限流

单机模式的限流非常简单，可以直接基于内存就可以实现，而集群模式的限流必须依赖于某个“中心化”的组件，比如网关或 Redis，从而引出两种不同的限流架构：**网关层限流** 和 **中间件限流**

分布式网关也依赖于中间件限流，跟中间件限流没有区别。

https://www.javazhiyin.com/68911.html

## 负载均衡

### 什么是负载均衡

负载均衡是指将访问流量根据负载均衡算法分发到后端服务器的流量分发控制服务
通过负载均衡可以提高微服务的可用性以及性能

### 常见负载均衡算法

- 简单轮询

  将请求按顺序分发给后端服务器上，不关心服务器当前的状态，比如后端服务的性能、当前的负载

- 加权轮询

  根据服务器自身的性能给服务器设置不同的权重，将请求按顺序和权重分发给后端服务器，可以让性能高的机器处理更多的请求

- 简单随机

  将请求随机分发给后端服务器上，请求越多，各个服务器接收到的请求越平均

- 加权随机

  根据服务器自身的性能给服务器设置不同的权重，将请求按各个服务器的权重随机分发给后端服务器

- 一致性哈希

  根据请求的客户端 ip、或请求参数通过哈希算法得到一个数值，利用该数值取模映射出对应的后端服务器，这样能保证同一客户端或相同参数的请求每次都使用同一台服务器

- 最小活跃数

  统计每台服务器上当前正在处理的请求树，也就是请求活跃数，将请求分发给活跃数最少的后台服务器

### 常见负载均衡组件

- nginx
- lvs
- ribbon

## RPC 调用

### 什么是 RPC 调用

RPC 就是远程过程调用
对于 Java 程序而言，RPC 就是远程方法调用，表示一个方法调用远程的另外一个方法
微服务架构中一个服务调用另一个服务就可以使用 RPC 调用

### RPC 调用与 HTTP 调用的区别

HTTP 调用使用的是 HTTP 协议，是网络 7 层中的应用层协议
HTTP 协议规定了数据传输的格式，Restful 风格就可以通过 Http 协议实现
RPC 不是网络层面的协议，而是更上层的更灵活的通信协议
RPC 调用可以自定义数据格式、数据传输方式、只要能保证调用到远程方法即可

### 常用的 RPC 调用组件或框架

- Dubbo
- gRPC
- Thrift
- Feign

## 服务熔断

### 什么是服务熔断

当服务 A 调用的某个服务 B 不可用时，上游服务 A 为了保证自己不受影响，从而不再调用服务 B，直接返回一个结果，减轻服务 A 和服务 B 的压力，直到服务 B 恢复

### 什么是熔断器

实现熔断功能的叫熔断器，代表组件为 Hystrix、Sentinel

### 熔断器的三种状态

- Closed

  - 当调用失败次数达到阈值时则启动熔断器

- Open

  - 此时不会真正调用下游服务，而是直接返回，当过了某段时间后，熔断器会进入到半打开状态

- Half-Open

  - 此时会有部分请求访问下游服务，如果这些请求都调用成功了，则认为下游服务恢复了，那么则关闭熔断器，否则熔断器回到打开状态

## 服务降级

### 什么是服务降级

当发现系统压力过载时，可以通过关闭某个服务，或限流某个服务来减轻系统压力

### 服务降级与服务熔断的区别

都是为了防止系统崩溃
都让用户体验到了某些功能暂时不可用
熔断是下游服务故障触发的，降级是为了降低系统负载

### 什么是服务雪崩

服务 A 调用服务 B，服务 B 调用服务 C，此时大量请求突然调用服务 A，假如服务 A 能抗住这些请求，但服务 C 抗不住，导致服务 C 请求堆积，从而服务 B 请求堆积，从而服务 A 不可用，这就是服务雪崩，解决方式就是服务降级和服务熔断

## 服务限流

### 什么是服务限流

服务限流是指在高并发请求下，为了保护系统，对访问服务的请求进行数量上的限制，从而防止系统不被大量请求压垮，在秒杀中，限流是非常重要的

### 常用的限流算法

- 固定窗口计数器
- 滑动窗口计数器
- 令牌桶
- 漏桶

## 全局锁

### 什么是全局锁

全局锁，就是我们常说的分布式锁，是分布式、微服务架构中的一种锁机制，通过全局锁可以很好地在分布式系统中互斥使用共享资源

### 全局锁的实现原理

- zookeeper

  利用 Zookeeper 的 watch 机制与临时节点特性

- Redis

  利用 redis 的消费订阅机制与数据超时特性

  setnx

### 常用全局锁实现组件

- Redisson
- Curator

## 控制总线

### 什么是控制总线

控制总线也成消息总线，是微服务系统中用来连接系统中所有服务节点的，微服务中的所有服务节点可以通过控制总线来进行通讯

### 控制总线的应用场景

目前，SpringCloudBus 是控制总线的具体实现，某个微服务可以通过 SpringCloudBus 来广播事件，而其他微服务可以接收到事件并进行相关处理

## 分布式事务

### 什么是分布式事务

在一次请求中，所涉及的分散在多个微服务上的操作要保证同时成功或同时失败，就是分布式事务
比如创建订单减库存、银行转账等

### 实现分布式事务的方式

- 直接通过数据库
- 通过消息队列
- 两阶段提交
- 三阶段提交

### 分布式事务中的三个角色

- 事务协调者
- 事务管理者
- 资源管理者

### 常用分布式事务框架

- seata
- lcn
- bytetcc

## 服务安全

### 什么是服务安全

服务的认证和授权是企业必需具备的
Spring Cloud Security 是 Spring Cloud 提供的微服务安全组件

### 服务安全的特性

- 1.可扩展、可配置的认证和授权
- 2.单点登录
- 3.防止会话固定、点击劫持、跨网站请求伪造等攻击
- 4.与 Servlet API 集成

## 链路追踪

### 什么是链路追踪

链路追踪为微服务系统提供了完整的调用链路还原、调用请求量统计、链路拓扑、应用依赖分析等功能，可以帮助开发者快速分析和诊断微服务架构下的性能瓶颈

### 链路追踪的功能

- 分布式调用链查询和诊断
- 应用性能实时汇总
- 分布式拓扑动态发现
- 多语言开发程序接入
- 丰富的下游对接场景

### 常用的链路追踪技术

- Sleuth
- Zipkin
  微服务离不开调用链监控，我们可以利用调用链监控快速排障。

CAT、Zipkin 和 SkyWalking 是 3 大主流的开源产品。

- Zipkin 是 Twitter 开源的调用链分析工具，目前基于 springcloud sleuth 得到了广泛的使用，特点是轻量，使用部署简单。

- SkyWalking 是本土开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点是支持多种插件，UI 功能较强，接入端无代码侵入。目前已加入 Apache 孵化器。

- CAT 是大众点评开源的基于编码和配置的调用链分析，应用监控分析，日志采集，监控报警等一系列的监控平台工具。

CAT

- 自研的序列化协议
- 文件查询引擎，可以不依赖 HDFS
  https://www.jianshu.com/p/9bb660190884

## 集群管理

### 什么是集群管理

集群管理是指，对于微服务系统中的某个服务集群所提供的针对集群管理的功能，Spring Cloud Cluster 的职责就是集群管理

### 集群管理有哪些功能

- 领导者选举
- 一致性存储
- 集群状态管理
- 一次性 tokens

## 事件驱动

### 什么是事件驱动

事件驱动就是消息驱动，在 Spring Cloud 中提供了 Spring Cloud Stream 来实现事件驱动，有了事件驱动，在微服务系统中可以更方便的通过发送消息来进行通信

### 事件驱动的概念

- 目标绑定器，目标指的是 kafka 或 rabbitmq
- 绑定桥梁，连接消息系统和应用程序
- 消息，应用程序和消息系统之间传递的数据

### 事件驱动的特点

- 异步处理
- 流量削峰
- 服务解耦

## 云连接器

### 什么是云链接器

云链接器可以用来更方便的链接部署在云上的各种服务
Spring Cloud 中的 Spring Cloud Connectors 就是云链接器的组件实现

### 目前支持的云平台

- SpringCloudCloudFoundry
- SpringCloudHeroKu

## 函数计算

### 什么是函数计算

函数计算也称函数式编程，是实现 Serverless 的一种手段，企业如果能使用函数计算能大大节约成本，在 Spring Cloud 中提供了 Spring Cloud Function 来开发基于云平台的函数计算

### 函数计算的特点

- 支持响应式等编程风格
- 输入输出类型透明转化
- 流数据处理
- 同一个 jvm 中运行多版本函数
- 打包函数到指定云平台

---

云原生环境：docker，k8s

单机版本 -> 集群版本

Seata 会不会有性能问题，感觉一般公式都不会用，都是用异步补偿机制

- 如果用分布式事务，就一定会影响性能；
- 不加锁，处理就得加锁，加锁就影响性能（redis 不加锁，解决事务问题，用单线程）
