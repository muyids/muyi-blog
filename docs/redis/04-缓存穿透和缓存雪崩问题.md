缓存雪崩、穿透、击穿问题

## 缓存雪崩

**缓存雪崩**, 即缓存**同一时间大面积的失效**，这个时候又来了一波请求，结果请求都打到数据库上，从而导致数据库连接异常。

发生原因：

- 缓存服务宕机
- 大量 key 同时过期
  **解决方案：**

避免发生：

- **服务高可用**：主从+哨兵，redis cluster，避免服务崩溃
- **随机失效时间**：不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀。
- **二级缓存：**A1 为原始缓存，A2 为拷贝缓存，A1 短期，A2 长期；A1 失效时，可以访问 A2

- **数据预热**：将发生大并发访问前，预先访问一遍

雪崩保护：

- **限流策略**：发生雪崩事中：本地`ehcache`缓存 + `hystrix` ，避免 MySQL 被打死

## 缓存穿透

**缓存穿透**，即黑客故意去**请求缓存中不存在的数据**，导致所有的请求都怼到数据库上，从而数据库连接异常。

低频的缓存穿透是 正常的，高频的缓存穿透才会影响数据库

### 缓存穿透解决方案

1. 同样的请求 ID 的情况；
   - **分布式锁**，使用**互斥锁**更新，保证同一个进程中针对同一个数据不会并发请求到 DB，减小 DB 压力。
   - 把查询到的结果（正常查询结果、NULL 值等）写入到缓存中，可以过滤掉同样的请求
2. 每次都是 不同的 ID（最常见的攻击场景）；
