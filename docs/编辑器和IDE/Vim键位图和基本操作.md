# vim 键位图

![vim_keyboard_2022-05-12_11-09-26](https://muyids.oss-cn-beijing.aliyuncs.com/vim_keyboard_2022-05-12_11-09-26.png)

# vim 模式

vim 有 3 种模式

- 普通模式

  - 由 Shell 进入 vi 编辑器时，首先进入普通模式。在普通模式下，从键盘输入任何字符都被当作命令来解释。

- 编辑模式

  - 编辑模式主要用于文本的输入。在该模式下，用户输入的任何字符都被作为文件的内容保存起来，并在屏幕上显示出来。

    在普通模式下，输入 a（附加命令）、c（修改命令）、i（插入命令）、o（另起新行）、r（取代命令）以及 s（替换命令）都将进入编辑模式，此时 vi 窗口的最后一行会显示“Insert”

- 命令模式

  - 命令模式下，用户可以对文件进行一些附加处理。尽管普通模式下的命令可以完成很多功能，但要执行一些如字符串查找、替换、显示行号等操作还是必须要进入命令模式的。

- Visual 模式

  - v 进入 Visual

    Ctrl + v 进入 Visual block

    - 选中后通过`y, d`进行复制或剪切;
    - 通过 p 或 P 进行粘贴;
      文本编辑器有很多，比如图形模式下的 gedit、kwrite 等，文本模式下的 vi、vim（vi 的增强版本）、emacs 等，本文介绍 vim 的一些基本操作

**模式切换**

# 位置移动

## 光标移动

- h - 向左
- j - 向下
- k - 向上
- i - 向右 kkkk

### 向指定方向移动（前后左右）

普通模式下，使用组合键`数字N(optional) + 方向键`实现光标移动

方向键

- 前 l、Space 键或方向键 →
- 后 h、空格键或方向键 ←
- 上 -、k、Ctrl+p 或方向键 ↑

  - +和 Enter 键是将光标移到下一行的行首
  - 其余命令仅是移到下一行，所在的列不变。如果下一行比当前光标所在位置还短，则下标到行尾。

- 下 +、Enter 键、j、Ctrl+n 或方向键 ↓

  - -命令将光标移到上一行行首
  - 另外 3 个保持在同一列。

### 移动到行首

普通模式下使用`0或^`命令

- 0 将光标移到当前行的第一个字符
- ^ 将光标移到当前行的第一个非空白符

### 移至行尾

普通模式下使用`$`命令

如果在该命令前加数字 n，则光标将下移到 n-1 行的行尾。

### 按词移动

- 按词前移 - 将光标后移至上一个单词的开头
  - w 以标点符号或空白符（如制表符、换行符或空格符）分隔的字母或数字串
  - W 搜索的词被定义为非空白符字符串

```
例如有字符串：
    echo l > /proc/sys/net/ipv4/conf/default/rp_filter

连续输入命令w，光标从行首移动的位置为：e、l、>、/、p、s、…、/、r、r。
而命令W，光标从行首移动的位置为：e、l、>、/、r。
```

- 按词后移 - 将光标后移至上一个单词的开头

  b 和 B

- 移至词尾

      e和E

## 移至指定行

- 命令模式 `:行号`
- 普通模式 `行号G`
  显示行号

```shell
:set number
:set nu
```

去掉行号

```shell
:set nonumber
:set nonu
```

## 屏幕滚动

在文件的编辑查看过程中经常涉及屏幕的滚动问题。

在 vi 编辑器中，尽管可以使用键盘上的 Page Up 键和 Page Dawn 键来完成这些操作，甚至使用方向键 ↑ 和 ↓，但是效率比较低，下面来看看相关屏幕滚动的命令。

### 向后滚动一屏

使用的命令为：Ctrl+f （滚屏后保留上一屏的最后两行）

### 向后滚动半屏

使用的命令为：Ctrl+d

### 向前滚动一屏

使用的命令为：Ctrl+b

### 向前滚动半屏

使用的命令为：Ctrl+u

### 屏幕定位

- 使用命令 zz 将当前行置为屏幕正中央
- 使用命令 zt 会将当前行置为屏幕顶端
- 命令 zb 则会将当前行置于屏幕底端

### 滚动至第一屏或最后一屏

```
- gg 定位于文件第一屏
- G 定位于文件最后一屏
```

# 文本编辑

## 文本输入、删除与修改

文本的输入、删除与修改是文件编辑的基本操作，其中大部分命令会将 vi 编辑器由普通模式切换为编辑模式，下面来介绍这些命令。

### 插入命令

```
i		# 将其后输出的字符插入到当前光标位置之前
I		# 将其后输入的字符插入到当前光标所在行的行首。
```

### 附加命令

```
a		# 将其后输入的字符插入到当前光标位置之后
A		# 将其后输入的字符追加到当前光标所在行的行尾
```

### 另起新行

```
o		# 在当前行的下面另起一行
O		# 在当前行的上面另起一行
```

另起新行的命令为 o 和 O。新行创建完后，光标停留在新行行首，等待输入文字。

### 删除字符

```
x		# 删除光标所在处的字符
X		# 删除光标前面的那个字符
```

删除字符的命令为 x 和 X。如果之前给出一个数字 n，则删除由光标所在字符开始向右的 n 个字符。

### 删除文本对象

```
dd 	# 删除光标所在的行
D		# 删除从光标所在位置开始到行尾的所有字符
```

字母 d 可以与光标移动命令组合，例如：

```
d^	# 从光标位置删至行首，不包括光标位。
d$	# 从光标位置删至行尾，包括光标位，与D作用相同。
dG	# 删除当前行至文件尾的内容。
dgg	# 删除当前行至文件头的内容。
```

## 修改命令

修改文本的命令为 cw,C 和 cc

作用是用新输入的文本取代原来的文本，这等价于将原来的文本删除后，利用命令 i 插入新的文本。

例如有一字符串：Hello World!

假设光标当前处在 e 处，输入命令 cw 后，屏幕显示如下：

H World!

此时光标处在 H 后的空格处，接着输入文本 i 后按 Esc 键，屏幕显示如下：

Hi World!

从上面可以看出，cw 只是修改光标当前位置到词尾的字符，如果要修改整个单词，可以使用命令 caw。

C 命令用来修改从光标位置到行尾的文本。如果在前面加一个数字 n，那么会把从当前光标位置至当前行下面的 n-1 行的内容都删除。

命令 cc 的功能和 C 相同，只是修改的范围不同，它修改光标所在的整行内容。

## 取代命令

取代文本的命令为 r 和 R。其中命令 r 是用其后输入的单个字符取代光标所在的字符，如果在 r 前加一个数字 n，则用其后输入的单个字符取代光标所在处开始向后的 n 个字符。

R 命令用其后输入的文本取代光标所在处开始的若干个字符，每输入一个字符就取代原有的一个字符，多出的部分附加在后面。

## 复制

命名缓冲区是以字母 a~z 命名的，利用命名缓冲区可以很好地保存若干文本段，便于以后存取、移动或者重排。访问这些缓冲区时，和前面一样，使用单个双引号。

复制文本的命令有如下两种格式：

- yy
- y<光标移动命令>
  其中 yy 表示复制整行内容，而后者则通过光标移动命令来限定被复制的文本，如果没有指定缓冲区的名字，文本就被插入到无名缓冲区中。如果用大写字母表示缓冲区，则文本就附加到该缓冲区中，缓冲区中原有的内容不会被覆盖。

## 粘帖

vi 编辑器中的缓冲区分为无名缓冲区和命名缓冲区。无名缓冲区以数字编号，一共有 9 个。前面讲过可以使用删除命令 x 和 dd 来删除文本，其实被删除的内容还保存在缓冲区中，最近一次删除的内容被保存在缓冲区 1 中，次近的在缓冲区 2 中，以此类推，我们可以使用命令把他们提取回来。

```
p # 往当前行之下 或 光标之后粘贴
P # 往当前行之上或光标之前粘贴
```

粘帖缓冲区内容的命令是 p 和 P，这两个命令的区别是：命令 p 将文本放在当前行之下或当前光标之后，而命令 P 将文本放在当前行之上或光标之前。

### 不使用缓冲区的复制与移动

使用的命令为 co，它的基本格式如下：

```
:<开始行>,<结束行> co <目标行>
```

这个命令在命令模式下执行，其中开始行和结束行标识了文本复制的范围，而目标行则是文本粘帖的位置。

**注：**

把`co` 改为 `m` 即完成剪切复制操作

## 查找与替换

### 简单替换表达式

```
:[range]s/from/to/[flags]
```

%表示所有行，$表示文件尾，

- range:搜索范围，如果没有指定范围，则作用于但前行。

  1. 1,10s/from/to/ 表示在第 1 到第 10 行（包含第 1，第 10 行）之间搜索替换；
  2. 10s/from/to/ 表示只在第 10 行搜索替换；
  3. %s/from/to/ 表示在所有行中搜索替换；
  4. 1,$s/from/to/ 同上。

- flags 有如下四个选项：

  1. c confirm，每次替换前询问；
  2. e error， 不显示错误；
  3. g globle，不询问，整行替换。如果不加 g 选项，则只替换每行的第一个匹配到的字符串；
  4. i ignore，忽略大小写。
     这些选项可以合并使用，如 cgi 表示不区分大小写，整行替换，替换前询问。

# 全局和多行文本操作

## sort 排序

[How to sort lines of text from within vim (super easy!)](https://webdevetc.com/blog/sort-text-in-vim/)

```
# sort
:sort

:'a,.sort

# How to sort in reverse
:%sort!
# How to remove duplicate lines in Vim
:%sort u
# How to do numeric sort
:sort n
```

## 删除指定行

### 删除 m 到 n 行

```shell
:<开始行>,<结束行> d
```

### 删除所有空行

#### 全局删除

```
:g/^s*$/d
```

简单解释一下：
g ：全区命令
/ ：分隔符
`^s*$ `：匹配空行，其中^表示行首，s 表示空字符，包括空格和制表符，\*重复 0 到 n 个前面的字符，$表示行尾。连起来就是匹配只有空字符的行，也就是空行。
/d ：删除该行

#### 替换的方式

如果空行中可能用空格的话, 可以先把空格都去除:

```
:%s/^\s\+$//
```

### 删除连续空行并保留一行

如果是空行中没有空格的话, 可以用替换:

```
:%s/\n\{3,\}/\r\r/
```

\n 表示换行, \{3,\} 表示三个以上的, 也就是超过两个空行, 替换成两个 \r (换行在替换的时候就是这样, 前面要用 \n, 后面要用 \r)

# 场景练习

**例子**

- 删除行尾空格: `%s/\s+$//g`
- 删除行首多余空格: `%s/^\s*//`
- 删除第 101 到 200 行行首空格：`101,200s/^\s\+//`
- 删除第 101 到 200 行行前 5 个字符：`101,200s/^.\{5\}//`
- 删除沒有內容的空行：`%s/^$//` 或者 `g/^$/d`
- 删除包含有空格组成的空行：`%s/^\s*$//` 或者 `g/^\s*$/d`
- 删除以空格或 TAB 开头到结尾的空行：`%s/^[ |\t]*$//` 或者 `g/^[ |\t]*$/d`
- 把文中的所有字符串"abc……xyz"替换为"xyz……abc"可以有下列写法
  - :%s/abc\(.\*\)xyz/xyz\1abc/g
  - :%s/\(abc\)\(.\*\)\(xyz\)/\3\2\1/g
