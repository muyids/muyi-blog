**可靠消息最终一致性事务**

当事务发起方执行完全本地事务后并发出一条消息，事务参与方（消息消费者）一定能够接收消息并处理事务成功

需要依靠消息中间件完成

**可靠消息最终一致性方案要解决以下几个问题：**

<1>本地事务与消息发送的原子性问题(核心问题)

事务发起方在本地事务执行成功后消息必须发出去，执行失败则不发送消息。

```sql
begin transaction；
		// 1.数据库操作
		// 2.发送MQ
commit transation；
```

如果发送 MQ 消息失败，就会抛出异常，导致数据库事务回滚。但如果发送 MQ 消息是超时异常，数据库回滚，但 MQ 其实已经正常发送来，会导致数据不一致。

解决方案：**本地消息表**

方案的核心是通过本地事务保证数据业务操作和消息的一致性，然后通过定时任务将消息发送至消息中间件，待确认消息发送给消费方成功再将消息删除。

```sql
begin transaction；
		// 1.数据库操作
		// 2.本地消息表记录为 未发送
commit transation；
// 3.发送MQ
// 4.修改本地消息表记录为 已发送

crontab:
	// 5.轮训 本地消息表，检查消息状态，未发送消息进行重试
```
